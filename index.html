<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Commission Finder</title>

  <script type="module">
    /* ───── Firebase SDK (v9+ modular) ───── */
    import { initializeApp }                 from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword,
             signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:            "AIzaSyCGk5rFFZV9jgjIirTYQjWv46qrdpmlL8I",
      authDomain:        "commission-finder-1bf8d.firebaseapp.com",
      projectId:         "commission-finder-1bf8d",
      storageBucket:     "commission-finder-1bf8d.appspot.com",
      messagingSenderId: "388186716424",
      appId:             "1:388186716424:web:c2ac138571911d79f694bd",
      measurementId:     "G-CKVT76PHWV"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ───── UI ELEMENTS ───── */
    const regForm   = document.getElementById("regForm");
    const logForm   = document.getElementById("logForm");
    const dash      = document.getElementById("dashboard");
    const btnLogout = document.getElementById("logout");
    const runBtn    = document.getElementById("runBtn");

    /* ───── Registration ───── */
    regForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const { firstName, lastName, email, password, license } = regForm;
      try {
        const licSnap = await getDoc(doc(db, "key", "license"));
        if (!licSnap.exists() || licSnap.data().key !== license.value.trim()) {
          return alert("❌  License key invalid");
        }
        const cred = await createUserWithEmailAndPassword(
          auth, email.value.trim(), password.value
        );
        await setDoc(doc(db, "users", cred.user.uid), {
          first : firstName.value.trim(),
          last  : lastName.value.trim(),
          email : email.value.trim(),
          created: Date.now()
        });
        regForm.reset();
        alert("✅  Registered! Log in now.");
      } catch (err) { alert("Error: " + err.message); }
    });

    /* ───── Login ───── */
    logForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        await signInWithEmailAndPassword(
          auth, logForm.emailL.value.trim(), logForm.passwordL.value
        );
        logForm.reset();
      } catch (err) { alert("Login failed: " + err.message); }
    });

    /* ───── Auth → UI swap ───── */
    onAuthStateChanged(auth, (user) => {
      document.getElementById("authSection").style.display = user ? "none" : "block";
      dash.style.display                                   = user ? "block" : "none";
    });

    /* ───── Run Cloud Function ───── */
    runBtn.addEventListener("click", async () => {
      if (!auth.currentUser) return alert("You must be logged in");

      const book  = document.getElementById("bookId").value.trim();
      const comm  = document.getElementById("commId").value.trim();
      const date  = document.getElementById("cutoffDate").value.trim();
      if (!book || !comm || !date) return alert("Enter the two IDs and a date.");

      runBtn.disabled = true;
      try {
        const idToken = await auth.currentUser.getIdToken(true);

        const resp = await fetch(
          "https://commissionfinder-1015944900243.us-central1.run.app",
          {
            method : "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${idToken}`
            },
            body: JSON.stringify({
              bookSheetId : book,
              commSheetId : comm,
              cutoffDate  : date            // new parameter
            })
          }
        );

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || resp.statusText);
        alert(`✅ Finished. ${data.count} client(s) with missing months – see your sheet.`);
      } catch (err) {
        alert("Function error: " + err.message);
      } finally {
        runBtn.disabled = false;
      }
    });

    /* ───── Logout ───── */
    btnLogout.onclick = () => auth.signOut();
  </script>

  <style>
    body{font-family:sans-serif;max-width:460px;margin:2rem auto}
    section{margin-bottom:2rem;padding:1rem;border:1px solid #ccc;border-radius:8px}
    #dashboard{display:none}
    input,button{padding:6px;margin:4px 0;width:100%}
  </style>
</head>
<body>
  <h1>Commission Finder</h1>

  <!-- Login / Registration box -->
  <div id="authSection">
    <section>
      <h2>Register</h2>
      <form id="regForm">
        <input name="firstName"  placeholder="First name" required>
        <input name="lastName"   placeholder="Last name"  required>
        <input name="email"      placeholder="Email"      type="email" required>
        <input name="password"   placeholder="Password"   type="password" required>
        <input name="license"    placeholder="License key" required>
        <button type="submit">Sign Up</button>
      </form>
    </section>

    <section>
      <h2>Log In</h2>
      <form id="logForm">
        <input name="emailL"    placeholder="Email"    type="email" required>
        <input name="passwordL" placeholder="Password" type="password" required>
        <button type="submit">Log In</button>
      </form>
    </section>
  </div>

  <!-- Post-login dashboard -->
  <section id="dashboard">
    <p>Enter the Google Sheet IDs and the cutoff date (<em>MM/DD/YYYY</em>), then press <strong>Run</strong>.</p>

    <input id="bookId"    placeholder="Book-of-Business Sheet ID">
    <input id="commId"    placeholder="Commission Statement Sheet ID">
    <input id="cutoffDate" placeholder="Cutoff Date (MM/DD/YYYY)">

    <button id="runBtn">Run</button>
    <button id="logout" style="background:#eee;">Log Out</button>
  </section>
</body>
</html>
