<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Commission Finder</title>

  <script type="module">
    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Firebase SDK (v9+ modular) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    import { initializeApp }                 from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword,
             signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    /* üîß 1)  FILL IN YOUR PROJECT SETTINGS */
    const firebaseConfig = {
      apiKey:            "AIzaSyCGk5rFFZV9jgjIirTYQjWv46qrdpmlL8I",
      authDomain:        "commission-finder-1bf8d.firebaseapp.com",
      projectId:         "commission-finder-1bf8d",
      storageBucket:     "commission-finder-1bf8d.appspot.com",
      messagingSenderId: "388186716424",
      appId:             "1:388186716424:web:c2ac138571911d79f694bd",
      measurementId:     "G-CKVT76PHWV"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ UI ELEMENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const regForm   = document.getElementById("regForm");
    const logForm   = document.getElementById("logForm");
    const dash      = document.getElementById("dashboard");
    const btnLogout = document.getElementById("logout");
    const runBtn    = document.getElementById("runBtn");
    const toggleBtn = document.getElementById("toggleDir");
    const arrowLbl  = document.getElementById("arrowLbl");

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  Registration  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    regForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const first = regForm.firstName.value.trim();
      const last  = regForm.lastName.value.trim();
      const email = regForm.email.value.trim();
      const pass  = regForm.password.value;
      const key   = regForm.license.value.trim();

      try {
        /* verify license */
        const licSnap = await getDoc(doc(db, "key", "license"));
        if (!licSnap.exists() || licSnap.data().key !== key) {
          return alert("‚ùå  License key invalid");
        }

        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, "users", cred.user.uid), {
          first, last, email, created: Date.now()
        });
        regForm.reset();
        alert("‚úÖ  Registered! Log in now.");
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  Login  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    logForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        await signInWithEmailAndPassword(
          auth, logForm.emailL.value.trim(), logForm.passwordL.value
        );
        logForm.reset();
      } catch (err) {
        alert("Login failed: " + err.message);
      }
    });

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  Auth state ‚Üí UI swap  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    onAuthStateChanged(auth, (user) => {
      document.getElementById("authSection").style.display = user ? "none" : "block";
      dash.style.display                                   = user ? "block" : "none";
    });

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  Direction toggle  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    let direction = "book_to_comm";          // default
    const updateArrow = () => {
      arrowLbl.textContent = direction === "book_to_comm" ? "‚û°Ô∏è" : "‚¨ÖÔ∏è";
    };
    updateArrow();

    toggleBtn.addEventListener("click", () => {
      direction = direction === "book_to_comm" ? "comm_to_book" : "book_to_comm";
      updateArrow();
    });

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  Run Cloud Function  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    runBtn.addEventListener("click", async () => {
      if (!auth.currentUser) return alert("You must be logged in");

      const book = document.getElementById("bookId").value.trim();
      const comm = document.getElementById("commId").value.trim();
      if (!book || !comm) return alert("Enter both IDs");

      runBtn.disabled = true;
      try {
        const idToken = await auth.currentUser.getIdToken(true);

        const resp = await fetch(
          "https://commissionfinder-1015944900243.us-central1.run.app",
          {
            method : "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${idToken}`
            },
            body: JSON.stringify({
              bookSheetId: book,
              commSheetId: comm,
              direction   : direction          // NEW
            })
          });

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || resp.statusText);
        alert(`‚úÖ Finished. ${data.count} row(s) missing ‚Äì see your sheet.`);
      } catch (err) {
        alert("Function error: " + err.message);
      } finally {
        runBtn.disabled = false;
      }
    });

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  Logout  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    btnLogout.onclick = () => auth.signOut();
  </script>

  <style>
    body{font-family:sans-serif;max-width:460px;margin:2rem auto}
    section{margin-bottom:2rem;padding:1rem;border:1px solid #ccc;border-radius:8px}
    #dashboard{display:none}
    input,button{padding:6px;margin:4px 0;width:100%}
    #dirRow{display:flex;align-items:center;gap:6px;margin:6px 0}
    #toggleDir{padding:4px 10px;cursor:pointer}
    .info{cursor:help;font-size:18px;line-height:1}
  </style>
</head>
<body>
  <h1>Commission Finder</h1>

  <!-- Login / Registration box -->
  <div id="authSection">
    <section>
      <h2>Register</h2>
      <form id="regForm">
        <input name="firstName"  placeholder="First name" required>
        <input name="lastName"   placeholder="Last name"  required>
        <input name="email"      placeholder="Email"      type="email" required>
        <input name="password"   placeholder="Password"   type="password" required>
        <input name="license"    placeholder="License key" required>
        <button type="submit">Sign Up</button>
      </form>
    </section>

    <section>
      <h2>Log In</h2>
      <form id="logForm">
        <input name="emailL"    placeholder="Email"    type="email" required>
        <input name="passwordL" placeholder="Password" type="password" required>
        <button type="submit">Log In</button>
      </form>
    </section>
  </div>

  <!-- Post-login dashboard -->
  <section id="dashboard">
    <p>Enter the two Google Sheet IDs, choose direction, then press <strong>Run</strong>.</p>

    <input id="bookId" placeholder="Book-of-Business Sheet ID">
    <input id="commId" placeholder="Commission Statement Sheet ID">

    <!-- Direction selector -->
    <div id="dirRow">
      <span class="info" title="Book ‚ûú Commission: find people in Book-of-Business NOT in Commission Statement.">‚ÑπÔ∏è</span>
      <strong>Book</strong>
      <button id="toggleDir" title="Click to reverse comparison">‚áÑ</button>
      <span id="arrowLbl">‚û°Ô∏è</span>
      <strong>Comm</strong>
      <span class="info" title="Commission ‚ûú Book: find people in Commission Statement NOT in Book-of-Business.">‚ÑπÔ∏è</span>
    </div>

    <button id="runBtn">Run Missing-Finder</button>
    <button id="logout" style="background:#eee;">Log Out</button>
  </section>
</body>
</html>
